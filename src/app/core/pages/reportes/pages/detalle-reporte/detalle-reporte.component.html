<!-- detalle-reporte.component.html -->
<div class="contenedor-detalle">
    <div class="cabecera">
        <button class="btn-volver" (click)="volverALista()">
            ← Volver a la lista
        </button>
        <h1>Detalle de reporte</h1>
    </div>

    <div *ngIf="reporte; else noEncontrado" class="contenido-detalle">
        <!-- Tarjeta de información de la reporte -->
        <div class="tarjeta-reporte">
            <div class="tarjeta-cabecera">
                <h2>reporte {{ reporte.folio }}</h2>
                <span class="badge-estado" [class]="'estado-' + reporte.estado.toLowerCase()">
                    {{ reporte.estado }}
                </span>
            </div>

            <div class="tarjeta-contenido">
                <div class="grid-datos">
                    <div class="campo">
                        <label>ID:</label>
                        <span>{{ reporte.id }}</span>
                    </div>
                    <div class="campo">
                        <label>Folio:</label>
                        <span>{{ reporte.folio }}</span>
                    </div>
                    <div class="campo">
                        <label>Nombre:</label>
                        <span>{{ reporte.nombre }}</span>
                    </div>
                    <div class="campo">
                        <label>Teléfono:</label>
                        <span>{{ reporte.telefono }}</span>
                    </div>
                    <div class="campo">
                        <label>Categoría:</label>
                        <span>{{ reporte.categoria }}</span>
                    </div>
                    <div class="campo">
                        <label>Subcategoría:</label>
                        <span>{{ reporte.subcategoria }}</span>
                    </div>
                    <div class="campo">
                        <label>Ubicación:</label>
                        <span>{{ reporte.ubicacion }}</span>
                    </div>
                    <div class="campo">
                        <label>Evidencia:</label>
                        <span>
                            <a [href]="reporte.evidencia_url" target="_blank" class="enlace-evidencia"
                                *ngIf="reporte.evidencia_url">
                                Ver evidencia
                            </a>
                            <span *ngIf="!reporte.evidencia_url" class="sin-evidencia">Sin evidencia</span>
                        </span>
                    </div>
                    <div class="campo">
                        <label>Estado:</label>
                        <span class="badge-estado" [class]="'estado-' + reporte.estado.toLowerCase()">
                            {{ reporte.estado }}
                        </span>
                    </div>
                    <div class="campo">
                        <label>Fecha:</label>
                        <span>{{ reporte.fecha | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="campo">
                        <label>Usuario Asignado:</label>
                        <span>{{ reporte.usuario_asignado }}</span>
                    </div>
                    <div class="campo">
                        <label>Área:</label>
                        <span>{{ reporte.area }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de asignación de técnico -->
        <div class="seccion-asignacion" *ngIf="usuarioLoggeado.rol === 'callcenter'">
            <h3>Asignar Técnico</h3>

            <div class="formulario-asignacion">
                <div class="campo-formulario">
                    <label for="tecnico">Seleccionar Técnico:</label>
                    <select id="tecnico" [(ngModel)]="tecnicoSeleccionado" class="select-tecnico">
                        <option [ngValue]="null">-- Seleccione un técnico --</option>
                        <option *ngFor="let tecnico of tecnicos" [value]="tecnico.email">
                            {{ tecnico.nombre }} - {{ tecnico.area }} ({{ tecnico.rol }})
                        </option>
                    </select>
                </div>

                <div class="acciones">
                    <button class="btn-asignar" (click)="asignarTecnico()" [disabled]="!tecnicoSeleccionado">
                        Asignar Técnico
                    </button>
                </div>
            </div>
        </div>
        <!-- ===================================== -->
        <!-- HISTÓRICO DE BITÁCORA DEL REPORTE -->
        <!-- ===================================== -->

        <div class="seccion-bitacora" *ngIf="bitacora.length > 0">
            <h3>Histórico de Bitácora</h3>

            <table class="tabla-bitacora">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Comentario</th>
                        <th>Usuario</th>
                    </tr>
                </thead>

                <tbody>
                    <tr *ngFor="let item of bitacora">
                        <td>{{ item.fecha_creacion | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>{{ item.comentario }}</td>
                        <td>{{ item.usuario || 'N/A' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div *ngIf="bitacora.length === 0" class="sin-registros">
            <p>No hay comentarios en la bitácora.</p>
        </div>

        <!-- Seccion cambiar estado -->
        <div class="seccion-asignacion" *ngIf="usuarioLoggeado.rol === 'tecnico'">
            <h3>Estado</h3>

            <div class="formulario-asignacion">
                <div class="campo-formulario">
                    <label for="estado">Favor cambia de estado</label>
                    <select class="select-tecnico" [(ngModel)]="estadoSeleccionado">
                        <option [ngValue]="null">-- Estado --</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="asignado">Asignado</option>
                        <option value="completado">Completado</option>
                    </select>
                </div>

                <div class="campo-formulario">
                    <label for="notas">Notas de estado:</label>
                    <textarea id="notas" [(ngModel)]="notas"
                        placeholder="Agregue notas adicionales para la asignación..." class="textarea-notas"
                        rows="4"></textarea>
                </div>

                <div class="acciones">
                    <button class="btn-asignar" (click)="onSubmit()">
                        Enviar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <ng-template #noEncontrado>
        <div class="mensaje-error">
            <h2>reporte no encontrada</h2>
            <p>La reporte que buscas no existe o ha sido eliminada.</p>
            <button class="btn-volver" (click)="volverALista()">
                Volver a la lista
            </button>
        </div>
    </ng-template>
</div>